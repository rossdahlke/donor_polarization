---
output:
  pdf_document:
    # citation_package: biblatex
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    template: ../svm-latex-ms.tex
title: "Political Donor Polarization"
thanks: 
author:
- name:
affiliation: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 10pt
spacing: double
bibliography: ../bibliography.bib
biblio-style: apsr
header-includes: \usepackage{graphicx}
---

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
library(tidyverse)
library(infer)
library(igraph)

load("misc_data.Rdata")
```

``` {r}
donors_geo <- by_donor %>%
  mutate(zip = str_sub(refined_source_zip, -5, -1)) %>% 
  left_join(rucc) %>% 
  filter(state == "WI")
```


```{r}
geo_bootstrap <- function(year_1 = "2014",
                          year_2 = "2012",
                          replications = 100,
                          party = "Both") {
  year_1 <- as.character(year_1)
  year_2 <- as.character(year_2)
  
  set.seed(1)

  table <- tibble()
 
  for(category in geo_calcs$geo_category)  {
      bootstrap <- donors_geo %>% 
      filter(election_year %in% c(year_1, year_2)) %>% 
        {if(party != "Both") filter(., party_bin == party) else .} %>%  
      filter(geo_category == category) %>%
      specify(abs_partisanship ~ election_year) %>% 
      generate(reps = replications, type = "bootstrap") %>% 
      calculate(stat = "diff in means", order = c(year_1, year_2))
  
    table <- rbind(table,
                   cbind(`Geographic Category` = category, Party = party,
    bootstrap %>% 
      get_ci() %>% 
     cbind(bootstrap %>% 
              summarize(mean_diff = mean(stat))) %>% 
      cbind(bootstrap %>% 
             get_p_value(obs_stat = 0, direction = "two_sided"))) %>%
       tibble())
  }
  table
}
```

## Testing Difference in Mean Partisanship by Geography

```{r include = T, warning = F, echo = F, message = F}
geo_table <- geo_bootstrap(2012,2010, 1000) %>% 
  mutate(cycle = "2012 compared to 2010") %>% 
  rbind(geo_bootstrap(2014,2012, 1000) %>% 
  mutate(cycle = "2014 compared to 2012")) %>% 
  mutate(ci = paste0(round(lower_ci, 5),"-",round(upper_ci, 5)),
         p_value = ifelse(p_value == 0, "<.001", p_value),
         mean_diff = round(mean_diff, 5)) %>% 
  select(`Geographic Category`, cycle, mean_diff, ci, p_value)

geo_table %>%
  knitr::kable(col.names = c("Geographic Category", "Election Year", "Diff.", "CI", "p"),
               caption = "Bootstrapped difference-in-means test with 1,000 replications comparing mean partisanship by geographic category.")
```


```{r}
geo_stats <- geo_table %>% 
  
  left_join(rbind(donors_geo %>% 
    mutate(indicator = ifelse(election_year %in% c(2012,2010), "yes", "no"),
           cycle = "2012 compared to 2010") %>%
    filter(indicator == "yes") %>% 
    group_by(geo_category, indicator, cycle) %>% 
    summarize(count= n()),
  donors_geo %>% 
    mutate(indicator = ifelse(election_year %in% c(2014,2012), "yes", "no"),
           cycle = "2014 compared to 2012") %>%
    filter(indicator == "yes") %>% 
    group_by(geo_category, indicator, cycle) %>% 
    summarize(count= n())) %>% 
  ungroup() %>% 
  select(-indicator),
    by = c("Geographic Category" = "geo_category", "cycle" = "cycle")) %>% 
  
  mutate(index = 8:1,
         lower = as.numeric(str_sub(ci, 1, -9)),
         upper = as.numeric(str_replace(ci, str_sub(ci, 1, -8), "")))
```

``` {r include = T, echo = F}
p1 <- ggplot(data = geo_stats, aes(y = index, x = mean_diff, xmin = lower, xmax = upper, color = cycle)) +
  geom_point(aes(size = count)) + 
  scale_size_continuous(range = c(1,3)) +
  geom_errorbarh(height = .1) +
  scale_y_continuous(name = "", breaks = 1:8, labels = rev(geo_stats$`Geographic Category`)) +
  labs(title = "Difference in Mean Partisanship by Geographic Category",
       x = "Difference in Means") +
  geom_vline(xintercept=0, color='black', linetype='dashed', alpha=.5) +
  #annotate(geom = "text", x = -.05, y = 1 + c(1.5, 5.5), label = c("2014 compared to 2012", "2012 compared to 2010"), size = 3.5, angle = 90) +
  coord_cartesian(xlim = c(-.005, .055), expand = T, clip = "off") +
  theme(plot.margin=unit(rep(.75, 4),"cm"), plot.title = element_text(hjust = .5))

ggsave(file = "geo_categories.png", plot = p1)
knitr::include_graphics("geo_categories.png")
```

  I grouped the donors according the four geographic categories to run the same difference-in-means test. The summary statistics tells a story that largely agrees with the results for the statewide analysis in Table 2; Wisconsin donors significantly polarized in the 2012 election cycle across both metropolitan and nonmetropolitan areas and remained that way come the 2014 election cycle. These results may spark the question: should we consider donor geography when looking at polarization? The answer may be rooted in what Cramer describes as "rural consciousness," or the strong sense of identity that the rural Wisconsinites felt alongside resentment towards the two main cities in a rising right-wing populist movement. The people outside of Madison and Milwaukee resonated with Scott Walker's appeal to their sense of distributive power injustice which was reflected in Act 10's attack on public employee unions. Indeed we can look at rural Wisconsin as well as cities excluding Madison and Milwaukee, which encompass the majority of Wisconsin's population. These two geographic categories had the greatest increase in polarization in both election cycles and were significant in both years. This confirms continuing support for Scott Walker and reflects the rural consciousness that continued to grow even after the 2012 election.


## Further Testing by Party 
```{r include = T, warning = F, echo = F, message = F}
party_geo_table <- geo_bootstrap(2012,2010, 1000, "democrat") %>% 
  mutate(cycle = "2012 compared to 2010") %>% 
  rbind(geo_bootstrap(2014,2012, 1000, "democrat") %>% 
  mutate(cycle = "2014 compared to 2012")) %>% 
  rbind(geo_bootstrap(2012,2010, 1000, "republican") %>% 
  mutate(cycle = "2012 compared to 2010")) %>% 
  rbind(geo_bootstrap(2014,2012, 1000, "republican") %>% 
  mutate(cycle = "2014 compared to 2012")) %>% 
  mutate(ci = paste0(round(lower_ci, 5),"-",round(upper_ci, 5)),
         p_value = ifelse(p_value == 0, "<.001", p_value),
         mean_diff = round(mean_diff, 5)) %>% 
  select(`Geographic Category`, Party, cycle, mean_diff, ci, p_value)

party_geo_table %>%
  knitr::kable(col.names = c("Geographic Category", "Party", "Election Year", "Diff.", "CI", "p"),
               caption = "Bootstrapped difference-in-means test with 1,000 replications comparing mean partisanship by geographic category.")
```

```{r}
party_geo_stats <- party_geo_table %>% 
  
  left_join(rbind(donors_geo %>% 
    mutate(indicator = ifelse(election_year %in% c(2012,2010), "yes", "no"),
           cycle = "2012 compared to 2010") %>%
    filter(indicator == "yes") %>% 
    group_by(geo_category, indicator, cycle, party_bin) %>% 
    summarize(count= n()),
  donors_geo %>% 
    mutate(indicator = ifelse(election_year %in% c(2014,2012), "yes", "no"),
           cycle = "2014 compared to 2012") %>%
    filter(indicator == "yes") %>% 
    group_by(geo_category, indicator, cycle, party_bin) %>% 
    summarize(count= n())) %>% 
  ungroup() %>% 
  select(-indicator),
    by = c("Geographic Category" = "geo_category", "cycle" = "cycle", "Party" = "party_bin")) %>% 
  
  mutate(index = rep(c(rep(2,4), rep(1,4)), 2),
         lower = as.numeric(str_sub(ci, 1, -9)),
         upper = as.numeric(str_replace(ci, str_sub(ci, 1, -8), "")))
```

``` {r include = T, echo = F}
p2 <- ggplot(data = party_geo_stats, aes(y = index, x = mean_diff, xmin = lower, xmax = upper, color = Party)) +
  facet_wrap(~`Geographic Category`) +
  scale_color_manual(values=c("blue", "red")) + 
  geom_point(aes(size = count)) + 
  scale_size_continuous(range = c(1,3)) +
  geom_errorbarh(height = .1) +
  scale_y_continuous(name = "", breaks = 1:2, labels = c("2014 compared to 2012", "2012 compared to 2010")) +
  labs(title = "Difference in Mean Partisanship by Geographic Category and Party",
       x = "Difference in Means") +
  geom_vline(xintercept = 0, color = 'black', linetype = 'dashed', alpha = .5) + 
  theme(plot.title = element_text(hjust = .5))

ggsave(file="geo_and_parties.png", plot = p2)
knitr::include_graphics("geo_and_parties.png")
```
To further analyze the partisan trends between Democrats and Republicans, I ran the same bootstrapping test for both parties in each of the geographic categories. In the 2012 compared to 2010 cycle, both parties had a significant mean difference in partisanship across the entire state, with Democrats consistently increasing their partisanship compared to Republicans. This aligns with the massive push to replace Governor Walker in the 2012 recall elections. Interestingly, despite the efforts among Democratic donors, the outcome of the election was not in their favor.

We can then move to note that in the 2014 to 2012 cycle, the Urban excluding Madison and Milwaukee and the Rural categories still had significant differences in partisanship. With this in mind, running the bootstrapping test allows us to see if this was true across both parties in these regions. The results of the test show that this was not the case. Somewhat unsurprisingly, only the  Republican donors had a significant difference in partisanship from 2012 to 2014. This can possibly be linked to the growing "rural consciousness" that rural Republicans felt as they continued to identify with Scott Walker's ideas. On the other hand, in urban Wisconsin outside of the two major cities, it was Democratic donors that had a super significant difference in partisanship in 2014 while Republican donors remained unchanged...


```{r echo = F}
ggplot(data = geo_stats, aes(x = cycle, y = mean_diff, fill = cycle)) +
  facet_grid(~`Geographic Category`) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.25, colour="black") +
  geom_bar(stat="identity",position=position_dodge()) +
  labs(title="Difference in Mean Partisanship by Geographic Category", x="", y = "Mean Difference", position=position_dodge(.9)) +
  scale_fill_manual(values=c("gray40", "gray70")) +
  theme(legend.position="bottom", plot.title = element_text(hjust = .5), axis.text.x = element_blank(), strip.text.x = element_text(size = 7))
```

## Comparing Old and New Donors (for a given election year)

```{r}
new_old_bootstrap <- function(year = 2012,
                          replications = 100) {
  set.seed(1)
  
  bootstrap <- by_donor %>% 
    filter(election_year == year) %>% 
    mutate(status = ifelse(refined_source_zip %in% unlist((by_donor %>% filter(election_year == year - 2) %>% select(refined_source_zip))), "old", "new")) %>% 
    specify(abs_partisanship ~ status) %>% 
    generate(reps = replications, type = "bootstrap") %>% 
    calculate(stat = "diff in means", order = c("new", "old"))
  
  bootstrap %>% 
    get_ci() %>% 
    cbind(bootstrap %>% 
            summarize(mean_diff = mean(stat))) %>% 
    cbind(bootstrap %>% 
            get_p_value(obs_stat = 0, direction = "two_sided"))
}
```

```{r include = T, warning = F, echo = F, message = F}
new_old_table <-  cbind(year = c("2012", "2014"),
  rbind(new_old_bootstrap(2012, 1000), new_old_bootstrap(2014, 1000))) %>%
            tibble() %>% 
            unnest() %>% 
  mutate(ci = paste0(round(lower_ci, 5),"-",round(upper_ci, 5)),
         p_value = ifelse(p_value == 0, "<.001", p_value),
         mean_diff = round(mean_diff, 5)) %>% 
  select(year, mean_diff, ci, p_value)

new_old_table %>%
  knitr::kable(col.names = c("Election Year", "Diff.", "CI", "p"),
               caption = "Bootstrapped difference-in-means test with 1,000 replications comparing mean partisanship of new versus old donors.")
```






